{"componentChunkName":"component---src-templates-post-tsx","path":"/cannot-acquire-lock-exception-research/","result":{"data":{"markdownRemark":{"html":"<p>ë‚´ê°€ ì§€ê¸ˆ íšŒì‚¬ì—ì„œ ê°œë°œí•œ ê²ƒ ì¤‘ì—ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ì•Œë¦¼ê³¼ ì‘í’ˆ, ì‹œìŠ¤í…œì— ëŒ€í•œ ì•Œë¦¼ ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” <code class=\"language-text\">Notification API</code>ê°€ ìˆê³  ëŒ“ê¸€ê³¼ ì‘í’ˆì˜ Rating, Likeë¥¼ ê´€ë¦¬í•˜ëŠ” <code class=\"language-text\">Community API</code>ê°€ ìˆë‹¤. ê·¸ëŸ°ë° ì´ ë‘ ì„œë¹„ìŠ¤ì—ì„œ ë¹ˆë„ëŠ” ë‚®ì§€ë§Œ, ê°„í˜¹ <code class=\"language-text\">CannotAcquireLockException</code>ì´ ë°œìƒí•˜ì—¬ ì›ì¸ì„ ì°¾ì•„ë³´ë ¤ê³  í–ˆë˜ ê³¼ì •ê³¼ ì‚¬ë¡€ë¥¼ ì ì–´ë³¸ë‹¤. </p>\n<h3 id=\"cannotacquirelockexception\" style=\"position:relative;\"><a href=\"#cannotacquirelockexception\" aria-label=\"cannotacquirelockexception permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CannotAcquireLockException</h3>\n<p><a href=\"https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/dao/CannotAcquireLockException.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ë¬¸ì„œ</a>ì—ëŠ” ì´ë¦„ê³¼ ê°™ì´ lockì„ ì–»ì§€ ëª»í•´ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì´ë‹¤. ë˜í•œ stack traceì˜ ë©”ì‹œì§€ì™€<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> ê²€ìƒ‰í•œ ê²°ê³¼ë¡œ ë³´ê±´ëŒ€ <code class=\"language-text\">Notification API</code>ì—ì„œëŠ” ì•Œë¦¼ì„ ì½ì€ ì‹œê°„ì„ ê¸°ë¡í•˜ëŠ” <code class=\"language-text\">Confirm API</code>ì™€ ëŒ“ê¸€ì„ Like í•˜ëŠ” <code class=\"language-text\">Comment Like API</code>ì—ì„œ ë°œìƒí–ˆê³  <code class=\"language-text\">deadlock</code>ê³¼ ê´€ë ¨ë˜ì–´ ë³´ì˜€ë‹¤.</p>\n<h3 id=\"deadlock\" style=\"position:relative;\"><a href=\"#deadlock\" aria-label=\"deadlock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deadlock</h3>\n<p>DBëŠ” íŠ¸ëœì­ì…˜ì„ ì•ˆì „í•˜ê²Œ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ lockì„ ì‚¬ìš©í•œë‹¤. ê·¸ëŸ°ë° íŠ¸ëœì­ì…˜ë“¤ì´ ì„œë¡œ í•„ìš”í•œ lockì„ ê°€ì§€ê³  ìˆì–´ ì§„í–‰í•  ìˆ˜ ì—†ëŠ” ìƒíƒœê°€ ë˜ëŠ” ê²ƒì´ deadlockì´ë‹¤. MySQL ë¬¸ì„œì— ìˆëŠ” <a href=\"https://dev.mysql.com/doc/refman/8.0/en/innodb-deadlock-example.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ì˜ˆì œ</a>ë¥¼ ë³´ë©´ ì–´ë–»ê²Œ deadlockì´ ë°œìƒí•˜ëŠ”ì§€ ë³´ì—¬ì¤€ë‹¤.  </p>\n<blockquote>\n<p>í´ë¼ì´ì–¸íŠ¸ Aì—ì„œ share modeë¡œ selectí•˜ì—¬ lockë¥¼ ì–»ëŠ”ë‹¤. share modeëŠ” íŠ¸ëœì­ì…˜ì´ ëë‚  ë•Œê¹Œì§€ ê°’ì´ ë³€ê²½ë˜ì§€ ì•Šë„ë¡ í•œë‹¤.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> t <span class=\"token punctuation\">(</span>i <span class=\"token keyword\">INT</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">InnoDB</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">1.07</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> t <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token keyword\">row</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.09</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t <span class=\"token keyword\">WHERE</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">SHARE</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+</span>\n<span class=\"token operator\">|</span> i    <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+</span></code></pre></div>\n<blockquote>\n<p>ê·¸ë¦¬ê³ , í´ë¼ì´ì–¸íŠ¸ Bì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  rowë¥¼ ì‚­ì œí•œë‹¤.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> t <span class=\"token keyword\">WHERE</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ì‚­ì œ ì‘ì—…ì€ <em>x</em> lockì„<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup> í•„ìš”ë¡œ í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  <em>s</em> lockì´ ìˆëŠ” ë™ì•ˆì€ x lockì„ íšë“¤ í•  ìˆ˜ ì—†ë‹¤. Aê°€ <em>s</em> lockì„ ê°€ì§€ê³  ìˆê³  Bì˜ ìš”ì²­ì€ queueë¡œ ì „ë‹¬ëœë‹¤.\nëìœ¼ë¡œ, Aê°€ rowë¥¼ ì‚­ì œí•˜ë ¤ê³  í•œë‹¤.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> t <span class=\"token keyword\">WHERE</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nERROR <span class=\"token number\">1213</span> <span class=\"token punctuation\">(</span><span class=\"token number\">40001</span><span class=\"token punctuation\">)</span>: Deadlock found <span class=\"token keyword\">when</span> trying <span class=\"token keyword\">to</span> get <span class=\"token keyword\">lock</span><span class=\"token punctuation\">;</span>\ntry restarting <span class=\"token keyword\">transaction</span></code></pre></div>\n<blockquote>\n<p>deadlockì€ ì´ë•Œ ë°œìƒí•œë‹¤. AëŠ” ì‚­ì œ ì‘ì—…ì„ í•˜ê¸° ìœ„í•´ <em>x</em> lockì´ í•„ìš”í•˜ì§€ë§Œ, Bê°€ <em>x</em> lockì— ëŒ€í•œ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ê³  ìˆê³  Aê°€ lockì„ í•´ì œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ InnoDBëŠ” í´ë¼ì´ì–¸íŠ¸ ì¤‘ í•˜ë‚˜ì˜ lockì„ í•´ì œí•˜ê³  ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.</p>\n</blockquote>\n<h3 id=\"confirm-api\" style=\"position:relative;\"><a href=\"#confirm-api\" aria-label=\"confirm api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Confirm API</h3>\n<p><code class=\"language-text\">Confirm API</code>ëŠ” ì•Œë¦¼ì„ ì½ì€ ì‹œê°„ì„ ê¸°ë¡í•˜ëŠ” APIì´ë‹¤. 30ì¼ ì´ë‚´ì˜ ìµœëŒ€ 50 ê±´ì˜ ì•Œë¦¼ì„ ê°€ì ¸ì™€ì„œ ì½ì§€ ì•Šì€ ì•Œë¦¼ë§Œ í˜„ì¬ ì‹œê°ìœ¼ë¡œ ê°±ì‹ í•˜ëŠ” ë¡œì§ì´ë‹¤. (<code class=\"language-text\">SimpleJpaRepository</code>ì˜ <code class=\"language-text\">saveAll()</code>ì„ ì‚¬ìš©í•œë‹¤.)ê²°êµ­, SELECTì™€ UPDATEí•˜ëŠ” ë¡œì§ì¸ë° UPDATE í•  ë•ŒëŠ” <em>x</em> lockì´ í•„ìš”í•˜ê² ì§€ë§Œ ìœ„ì˜ ì˜ˆì œì²˜ëŸ¼ SELECTí•  ë•Œ share modeë¥¼ ì“°ê±°ë‚˜ í•˜ì§€ ì•Šì•„ <em>s</em> lockì´ í•„ìš”í•˜ì§€ ì•Šë‹¤. ê·¸ë ‡ë‹¤ë©´ ì™œ ë°œìƒí•œ ê±¸ê¹Œ?</p>\n<p><code class=\"language-text\">SHOW ENGINE INNODB STATUS</code> ëª…ë ¹ì–´ì˜ <code class=\"language-text\">LATEST DETECTED DEADLOCK</code> í•­ëª©ì— ì•„ë˜ì˜ ë‚´ìš©ì´ ìˆì—ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">------------------------\nLATEST DETECTED DEADLOCK\n------------------------\n2020-05-30 08:47:32 2b246ec44700\n*** (1) TRANSACTION:\nTRANSACTION 828466999, ACTIVE 0 sec starting index read\nmysql tables in use 1, locked 1\nLOCK WAIT 3 lock struct(s), heap size 376, 2 row lock(s), undo log entries 1\nMySQL thread id 18147477, OS thread handle 0x2b1effe82700, query id 1061155561\nupdate notification set contents='Kelas Rahasia Sang Permaisuri \\\"gukguk item tsundere sedang guguk putih masochist ğŸ¤­ğŸ¤£\n\\\"', created='2020-05-30 08:44:15', icon_uri='icon/notification/x2/comment.jpg.webp', landing_uri='idn.kakaopage://comment/3311/151580/791309', push_id='LIKE_COMMENT-791309-1590828254', title='\\'athyy dan 58orang lainya\\' telah menyukai komentar kamu.', type_code='LIKE_COMMENT', user_id='idnub265f96b23bb86', viewed='2020-05-30 08:47:32.551' where id=199064878\n*** (1) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 13 page no 6567228 n bits 48 index `PRIMARY` of table `page-notification`.`notification` trx id 828466999 lock_mode X locks rec but not gap waiting\nRecord lock, heap no 48 PHYSICAL RECORD: n_fields 12; compact format; info bits 0\n\n*** (2) TRANSACTION:\nTRANSACTION 828466998, ACTIVE 0 sec starting index read\nmysql tables in use 1, locked 1\nLOCK WAIT 3 lock struct(s), heap size 376, 2 row lock(s), undo log entries 1\nMySQL thread id 18147633, OS thread handle 0x2b1eff2c5700, query id 1061155560\nupdate notification set contents='Adonis \"masih gagal pahamğŸ˜ğŸ˜¶ğŸ˜¶\"', created='2020-05-30 08:25:53.0', icon_uri='icon/notification/x2/comment.jpg.webp', landing_uri='idn.kakaopage://comment/2267/24187/1213101', push_id='REPLY_TO_COMMENT-1213101-1590827152', title='byun baekhyun meninggalkan jawaban di komentarmu.', type_code='REPLY_TO_COMMENT', user_id='idnub265f96b23bb86', viewed='2020-05-30 08:47:32.551' where id=199063150\n*** (2) HOLDS THE LOCK(S):\nRECORD LOCKS space id 13 page no 6567228 n bits 48 index `PRIMARY` of table `page-notification`.`notification` trx id 828466998 lock_mode X locks rec but not gap\nRecord lock, heap no 48 PHYSICAL RECORD: n_fields 12; compact format; info bits 0\n[bitmap0 of 16 bytes in hex: 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 ]\n\n*** (2) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 13 page no 6567189 n bits 52 index `PRIMARY` of table `page-notification`.`notification` trx id 828466998 lock_mode X locks rec but not gap waiting\nRecord lock, heap no 52 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</code></pre></div>\n<p>ì´ ë‚´ìš©ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆëŠ” ì‚¬ì‹¤ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>\n<ul>\n<li><code class=\"language-text\">TRANSACTION 1</code>ì€ idê°€ 199064878ì¸ rowë¥¼ UPDATE í•œë‹¤. </li>\n<li><code class=\"language-text\">TRANSACTION 2</code>ëŠ” idê°€ 199063150ì¸ rowë¥¼ UPDATE í•œë‹¤. </li>\n<li><code class=\"language-text\">TRANSACTION 1</code>ì€ UPDATEí•˜ëŠ” recordì— ëŒ€í•œ <em>x</em> lockì´ í•„ìš”í•˜ì—¬ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.</li>\n<li><code class=\"language-text\">TRANSACTION 2</code>ëŠ” UPDATEí•˜ëŠ” recordì— ëŒ€í•œ <em>x</em> lockì´ í•„ìš”í•˜ì—¬ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.</li>\n<li><code class=\"language-text\">TRANSACTION 2</code>ëŠ” <code class=\"language-text\">TRANSACTION 1</code>ì´ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” recordì˜ <em>x</em> lockì„ ê°€ì§€ê³  ìˆë‹¤.</li>\n</ul>\n<p>ì´ ê³¼ì •ëŒ€ë¡œ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ë©´ ì¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤.</p>\n<blockquote>\n<p>í…Œì´ë¸”ì„ ìƒì„±.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>val<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ìœ„ì™€ ê°™ì´ ë°ì´í„°ë¥¼ ì…ë ¥.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"> <span class=\"token operator\">+</span><span class=\"token comment\">-------------+</span>\n <span class=\"token operator\">|</span> id   <span class=\"token operator\">|</span> val  <span class=\"token operator\">|</span>\n <span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span>\n <span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n <span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span>\n <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n <span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span></code></pre></div>\n<blockquote>\n<p>ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ idê°€ 1ì¸ recordì˜ <em>x</em> lock íšë“.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client A</span>\n<span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ idê°€ 2ì¸ recordì˜ <em>x</em> lock íšë“.\nê·¸ë¦¬ê³  idê°€ 1ì¸ recordì˜ <em>x</em> lockì„ ì–»ê¸° ìœ„í•´ ëŒ€ê¸°.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client B</span>\n<span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ë‹¤ì‹œ ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ idê°€ 2ì¸ recordì˜ <em>x</em> lock íšë“ ì‹œë„.\nì—¬ê¸°ì„œ deadlockë°œìƒ.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client A</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ì¬í˜„ ë°©ë²•ì€ ì–´ë µì§€ ì•Šì€ë° ìœ„ì˜ ê³¼ì •ì²˜ëŸ¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ 2ê°œ ì´ìƒì˜ UPDATEëª…ë ¹ì„ ì‹¤í–‰í•´ì•¼ ë°œìƒí•œë‹¤. í•˜ì§€ë§Œ ë‚˜ëŠ” íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•œ ì ì´ ì—†ì—ˆëŠ”ë° deadlockì´ ë°œìƒí•œ ê²ƒì´ ì˜ì•„í–ˆë‹¤. ê·¸ëŸ¬ë‹¤ê°€ <code class=\"language-text\">saveAll()</code> ì½”ë“œë¥¼ í™•ì¸í•´ ë³´ì•˜ëŠ”ë° ì—¬ê¸°ì— íŠ¸ëœì­ì…˜ ì–´ë…¸í…Œì´ì…˜ì´ ì‚¬ìš©ë˜ê³  ìˆì—ˆë‹¤. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> entities<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ì´ì œëŠ” deadlockì´ ë°œìƒí–ˆì„ ë•Œì˜ ìƒí™©ì„ ì•Œ ê²ƒë„ ê°™ë‹¤. </p>\n<ol>\n<li>ì§¦ì€ ì‹œê°„ ì•ˆì— <code class=\"language-text\">Confirm API</code>ê°€ ë™ì‹œì— í˜¸ì¶œë˜ì–´</li>\n<li>ì½ì€ ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ ì•Œë¦¼ ëª©ë¡ì„ <code class=\"language-text\">saveAll()</code>ë¡œ ì—…ë°ì´íŠ¸í•  ë•Œ</li>\n<li>ê°™ì€ ì•Œë¦¼ëª©ë¡ì„ ëŒ€ìƒìœ¼ë¡œ í•˜ì—¬ë„ ì—…ë°ì´íŠ¸ê°€ ìˆ˜í–‰ë˜ëŠ” ìˆœì„œëŠ” ë³´ì¥ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì—</li>\n<li>ì„œë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ lockì„ í•„ìš”ë¡œí•˜ëŠ” ìƒí™©ìœ¼ë¡œ deadlock ë°œìƒí•œ ê²ƒì´ë‹¤.</li>\n</ol>\n<h3 id=\"comment-like-api\" style=\"position:relative;\"><a href=\"#comment-like-api\" aria-label=\"comment like api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comment Like API</h3>\n<p><code class=\"language-text\">Comment Like API</code>ëŠ” ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë¥¼ í˜¸ì¶œë˜ëŠ” APIì´ë‹¤. comment, comment_like 2ê°œì˜ í…Œì´ë¸”ì„ ì‚¬ìš©í•œë‹¤. comment_likeì—ëŠ” ì‚¬ìš©ìê°€ ëŒ“ê¸€ì— ì¢‹ì•„ìš” ì„¤ì • ë˜ëŠ” ì·¨ì†Œí•œ ìƒíƒœë¥¼ commentì—ëŠ” ëŒ“ê¸€ê³¼ ì¢‹ì•„ìš” ìˆ«ìë¥¼ í•„ë“œë¡œ ê°€ì§€ê³  ìˆë‹¤. ì•„ë˜ëŠ” 2ê°œì˜ í…Œì´ë¸”ì„ ê°„ëµí™”í•œ ìŠ¤í‚¤ë§ˆì´ë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>like_count<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment_like<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>is_like<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">tinyint</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">CONSTRAINT</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>fk_commentLike_commentId<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>comment<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></code></pre></div>\n<p>ì´ê²ƒë„ <code class=\"language-text\">SHOW ENGINE INNODB STATUS</code>ë¡œ deadlock ì •ë³´ë¥¼ ì°¾ì•„ë³´ì•˜ë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">------------------------\nLATEST DETECTED DEADLOCK\n------------------------\n2020-06-10 17:16:42 2b221d246700\n*** (1) TRANSACTION:\nTRANSACTION 1124624957, ACTIVE 0 sec starting index read\nmysql tables in use 1, locked 1\nLOCK WAIT 5 lock struct(s), heap size 376, 2 row lock(s), undo log entries 1\nMySQL thread id 5148115, OS thread handle 0x2b1c5c38a700, query id 1602285300 update comment set like_count=like_count+1, updated='2020-06-10 17:16:42.991' where id=1105292\n*** (1) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 8 page no 22700 n bits 36 index `PRIMARY` of table `page-community`.`comment` trx id 1124624957 lock_mode X locks rec but not gap waiting\nRecord lock, heap no 36 PHYSICAL RECORD: n_fields 15; compact format; info bits 0\n\n*** (2) TRANSACTION:\nTRANSACTION 1124624956, ACTIVE 0 sec starting index read\nmysql tables in use 1, locked 1\nLOCK WAIT 5 lock struct(s), heap size 376, 2 row lock(s), undo log entries 1\nMySQL thread id 5148104, OS thread handle 0x2b1cada44700, query id 1602285299 update comment set like_count=like_count+1, updated='2020-06-10 17:16:42.988' where id=1105292\n*** (2) HOLDS THE LOCK(S):\nRECORD LOCKS space id 8 page no 22700 n bits 36 index `PRIMARY` of table `page-community`.`comment` trx id 1124624956 lock mode S locks rec but not gap\nRecord lock, heap no 36 PHYSICAL RECORD: n_fields 15; compact format; info bits 0\n\n*** (2) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 8 page no 22700 n bits 36 index `PRIMARY` of table `page-community`.`comment` trx id 1124624956 lock_mode X locks rec but not gap waiting\nRecord lock, heap no 36 PHYSICAL RECORD: n_fields 15; compact format; info bits 0</code></pre></div>\n<p><code class=\"language-text\">Confirm API</code>ì™€ ìœ ì‚¬í•˜ì§€ë§Œ ë‘ ê°œì˜ íŠ¸ëœì­ì…˜ì´ í•˜ë‚˜ì˜ rowë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ë‘ ë²ˆì§¸ íŠ¸ëœì­ì…˜ì´ <em>x</em>ê°€ ì•„ë‹Œ <em>S</em> lockì„ ê°€ì§€ê³  ìˆëŠ” ê²ƒì´ ëˆˆì— ëˆë‹¤. ì´ ë¡œì§ì—ì„œë„ ëª…ì‹œì ìœ¼ë¡œ lockì„ ì„ ì–¸í•œ ë¶€ë¶„ì´ ì—†ëŠ”ë° ì™œ deadlockì´ ë°œìƒí•œ ê²ƒì¼ê¹Œ?</p>\n<p>InnoDBì—ì„œ lockì„ ì„¤ì •í•˜ëŠ” ê²½ìš°ë¥¼ ë‚˜ì—´í•´ë†“ì€ <a href=\"https://dev.mysql.com/doc/refman/5.6/en/innodb-locks-set.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ë¬¸ì„œ</a>ì—ì„œ Foreign Key ì¡°ê±´ì—ì„œ <em>s</em> lockì„ ì„¤ì •í•œë‹¤ê³  ë‚˜ì™€ìˆë‹¤.</p>\n<blockquote>\n<p>FOREIGN KEYê°€ í…Œì´ë¸”ì— ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ì œì•½ì¡°ê±´ì„ í™•ì¸í•´ì•¼ í•  ëª¨ë“  insert, update, deleteëŠ” ì œì•½ì¡°ê±´ì„ ì°¸ì¡°í•˜ê³  ìˆëŠ” recordì— shared lockì„ ì„¤ì •í•œë‹¤.\në˜í•œ, InnoDBëŠ” ì œì•½ì¡°ê±´ì´ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ì—ë„ lockì„ ì„¤ì •í•œë‹¤.</p>\n</blockquote>\n<p>ì´ ë‚´ìš©ëŒ€ë¡œ ì¶”ë¡ í•´ë³´ë©´ ì•„ë˜ì˜ ê³¼ì •ìœ¼ë¡œ ì¬í˜„í•  ìˆ˜ ìˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_child<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>val<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>fk_deadlock_id<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">CONSTRAINT</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>fk_deadlock_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>deadlock í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ëŠ” deadlock_child í…Œì´ë¸” ìƒì„±.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client A </span>\n<span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_child<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>val<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìì‹ í…Œì´ë¸”ì— insertí•˜ì—¬ deadlock í…Œì´ë¸”ì˜ idê°€ 1ì¸ recordì˜ <em>s</em> lock íšë“.  </p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client B</span>\n<span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_child<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>deadlock_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>val<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë™ì¼í•˜ê²Œ deadlock í…Œì´ë¸”ì˜ idê°€ 1ì¸ recordì˜ <em>s</em> lock íšë“.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client A</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ <em>x</em> lock íšë“ì„ ìœ„í•´ ëŒ€ê¸°.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Client B</span>\n<span class=\"token keyword\">UPDATE</span> deadlock <span class=\"token keyword\">SET</span> val <span class=\"token operator\">=</span> <span class=\"token number\">101</span> <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ë„ <em>x</em> lockì´ í•„ìš”. ì—¬ê¸°ì„œ deadlock ë°œìƒ.</p>\n</blockquote>\n<p>ì´ê²ƒë„ ì§§ì€ ì‹œê°„ ì•ˆì— ê°™ì€ APIê°€ ë™ì‹œì— ìš”ì²­ë˜ì–´ ë°œìƒí•œ ë¬¸ì œë¼ê³  ì—¬ê²¨ì§„ë‹¤.</p>\n<h3 id=\"í•´ê²°ì€-ì–´ë–»ê²Œ-í•˜ë‚˜\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EB%82%98\" aria-label=\"í•´ê²°ì€ ì–´ë–»ê²Œ í•˜ë‚˜ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>í•´ê²°ì€ ì–´ë–»ê²Œ í•˜ë‚˜?</h3>\n<p>ì´ê²ƒ ë˜í•œ MySQL <a href=\"https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlocks-handling.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ë¬¸ì„œ</a>ì—ì„œ deadlockë¥¼ ì–´ë–»ê²Œ ìµœì†Œí™”í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œë ¤ì¤€ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œëŠ” deadlockì´ ë°œìƒí•  ë•ŒëŠ” ì¬ì‹œë„ í•˜ë¼ê³  í•˜ê³  ìˆìœ¼ë©° íŠ¸ëœì­ì…˜ì„ ì§§ê²Œ ì„¤ì •í•˜ë¼ê³  í•˜ê³  ìˆë‹¤. <code class=\"language-text\">Confirm API</code>ì˜ ê²½ìš°ì—ëŠ” í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ì¿¼ë¦¬ê°€ ìµœëŒ€ 50ê°œê°€ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— <code class=\"language-text\">UPDATE ... WHERE IN</code> ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ê³  í•œë‹¤. (2ê°œì˜ rowë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²½ìš°ì—ë„ deadlockì´ ë°œìƒí•˜ê¸°ë„ í–ˆë‹¤.)<br>\n<code class=\"language-text\">Comment Like API</code>ëŠ” ë¶€ëª¨ í…Œì´ë¸”ì„ ë¨¼ì € ì—…ë°ì´íŠ¸í•˜ë©´ deadlockì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¿¼ë¦¬ì— í•„ìš”í•œ lockì„ ë¯¸ë¦¬ íšë“í•˜ê¸° ë•Œë¬¸ì¸ë° ìˆœì„œë¥¼ ë³€ê²½í•˜ì—¬ë„ ë¡œì§ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì— ìˆœì„œë¥¼ ë°”ê¿”ë„ ë¬´ë°©í•˜ë‹¤.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Deadlock found when trying to get lock; try restarting transaction</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">â†©</a>\n</li>\n<li id=\"fn-2\">\n<p><a href=\"https://jeong-pro.tistory.com/94\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://jeong-pro.tistory.com/94</a></p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">â†©</a>\n</li>\n</ol>\n</div>","excerpt":"ë‚´ê°€ ì§€ê¸ˆ íšŒì‚¬ì—ì„œ ê°œë°œí•œ ê²ƒ ì¤‘ì—ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ì•Œë¦¼ê³¼ ì‘í’ˆ, ì‹œìŠ¤í…œì— ëŒ€í•œ ì•Œë¦¼ ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” ê°€ ìˆê³  ëŒ“ê¸€ê³¼ ì‘í’ˆì˜ Rating, Likeâ€¦","tableOfContents":"<ul>\n<li><a href=\"/cannot-acquire-lock-exception-research/#cannotacquirelockexception\">CannotAcquireLockException</a></li>\n<li><a href=\"/cannot-acquire-lock-exception-research/#deadlock\">Deadlock</a></li>\n<li><a href=\"/cannot-acquire-lock-exception-research/#confirm-api\">Confirm API</a></li>\n<li><a href=\"/cannot-acquire-lock-exception-research/#comment-like-api\">Comment Like API</a></li>\n<li><a href=\"/cannot-acquire-lock-exception-research/#%ED%95%B4%EA%B2%B0%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EB%82%98\">í•´ê²°ì€ ì–´ë–»ê²Œ í•˜ë‚˜?</a></li>\n</ul>","fields":{"slug":"/cannot-acquire-lock-exception-research/"},"frontmatter":{"title":"CannotAcquireLockExceptionê³¼ Deadlock","date":"2020ë…„ 6ì›” 19ì¼ ê¸ˆìš”ì¼","tags":["CannotAcquireLockException","deadlock"],"keywords":["Running Out Of Coins.","bgroot"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/cannot-acquire-lock-exception-research/","series":[],"lastmod":"0001-01-01"}},"staticQueryHashes":["3649515864","63159454"]}