{"componentChunkName":"component---src-templates-post-tsx","path":"/memory-leak-the-first/","result":{"data":{"markdownRemark":{"html":"<p>현재 플랫폼을 개발하고 운영하면서 몇 차례의 메모리 누수 문제를 겪었는데 이것들을 해결했던 과정과 그 원인을 적어보려고 한다. 발생한 지 몇 개월이 지난 것들이지만 혹시 나와 같은 문제를 겪는 사람이 있다면 도움이 되었으면 좋겠다.</p>\n<h3 id=\"문제-발생\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\" aria-label=\"문제 발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 발생</h3>\n<p>가장 처음으로 발생했던 메모리 관련 문제는 서비스를 오픈하고 많은 날이 지나지 않았을 때였던 걸로 기억한다. 주말에도 마음 편하게 쉬지를 못하는 때였으니까...\n아니나 다를까 정확한 선후 관계는 기억이 나지 않지만, 서비스가 느려진 것을 인지하고 각 서비스 상태를 모니터링했었다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2401ed5080499c7bc1f658aa3ecc23c6/a2498/community-cpu-log-by-memory-leak.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.142857142857146%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABc0lEQVQoz42R626cMBBGef/nqqrkT1Qp2iTdS7ILu9xs7hgMNpwatmqzbSJlpCNGNvP5mxmv6wf6YWSJeZ6Z3XfSilH6mCbDqmrlz/0HLDEaS6M0njHmnx/Ajpp5mpjMiHXiZujXhz4TfI9nrb09dIVWt0x2ZHZ3Q1eT5PHXBf9zuNgvnYA1K2PfIkt5095H+dqR4+rQJSuLu1oyxnuWqVonqNqCsEiuxY72dYfpFJMTMapdRabftQuecYLvwzaCyDn8trlj5/+krFKSpx/Yc8Cw3zKejujtC/3mEROFfwsrtzwpnaDuUXFILxL6JKI+H7kct+jAp359IXm8RwQ7Qn9PmkVkgyIKDqQyIj6/EW4eVvyH7wj/gDcNmjoMHGd0llIER+aqZHHelLk7E2SFQLrlhFlCXKSIUnCRMZkqOR2eSUVI3BSIpsTrzcxJFO71jDyNEZcToihJXZ5Vgk4PyDynaCpU09K16triNN+MahngsodfBei4NquPr2oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"아니... 서버 CPU의 상태가?\"\n        title=\"아니... 서버 CPU의 상태가?\"\n        src=\"/static/2401ed5080499c7bc1f658aa3ecc23c6/b06ae/community-cpu-log-by-memory-leak.png\"\n        srcset=\"/static/2401ed5080499c7bc1f658aa3ecc23c6/0d3e1/community-cpu-log-by-memory-leak.png 140w,\n/static/2401ed5080499c7bc1f658aa3ecc23c6/908b1/community-cpu-log-by-memory-leak.png 280w,\n/static/2401ed5080499c7bc1f658aa3ecc23c6/b06ae/community-cpu-log-by-memory-leak.png 560w,\n/static/2401ed5080499c7bc1f658aa3ecc23c6/1e088/community-cpu-log-by-memory-leak.png 840w,\n/static/2401ed5080499c7bc1f658aa3ecc23c6/f43e4/community-cpu-log-by-memory-leak.png 1120w,\n/static/2401ed5080499c7bc1f658aa3ecc23c6/a2498/community-cpu-log-by-memory-leak.png 1764w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">아니... 서버 CPU의 상태가?</figcaption>\n  </figure></p>\n<p>이 그래프에서 보다시피 특정 인스턴스 몇 대가 무슨 짓을 하는지 갑자기 CPU Utilization이 치솟는 현상이 있었고 이 서비스로 HTTP Call을 하는 다른 컴포넌트에도 영향을 미치고 있었다. 암담한 심정과 더불어 도무지 원인을 알 수가 없었는데 갑자기 CPU가 치솟는 현상을 경험한 적이 없었기 때문이다. 그래서 문제가 있는 인스턴스들을 재시작하였고 서비스 상태는 잠잠해진 듯했다. 문제가 언제 다시 발생할지 몰라 조마조마하긴 했지만.</p>\n<h3 id=\"원인-파악\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8-%ED%8C%8C%EC%95%85\" aria-label=\"원인 파악 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인 파악</h3>\n<p>계속 모니터링하다 보니 시간이 지나면 문제의 현상이 재현되었고 LB에서 제외하여 해당 인스턴스에서 문제를 파악해 보기로 했다. <code class=\"language-text\">top</code> 명령으로 보았을 때 java가 CPU를 가장 많이 점유하고 있는 것을 확인 할 수 있었고 <code class=\"language-text\">top -H -p pid</code>로 java의 특정 thread가 CPU를 많이 사용함을 알 수 있었다. </p>\n<p>그리고 <code class=\"language-text\">sudo -u user jstack -l pid</code> 명령으로 jvm의 thread dump의 tid와 대조한 결과 그 thread가 GC thread라는 것을 알 수 있었다. 즉, 이유는 모르겠는데 GC를 수행하느라 CPU를 많이 쓰고 있고 GC가 수행되어도 메모리 해제가 되지 않았기 때문에 현재 상태에 도달했을 것이다. 이때부터 메모리 누수가 의심되기 시작했다. (그때 <code class=\"language-text\">jstat</code>을 사용했다면 좀 더 의미 있는 상태 분석을 했을 것 같다.) </p>\n<h3 id=\"메모리-분석\" style=\"position:relative;\"><a href=\"#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EB%B6%84%EC%84%9D\" aria-label=\"메모리 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>메모리 분석</h3>\n<p>메모리 누수가 의심되는 상황이기는 했지만 역시나 원인이 짐작도 되지 않았다. 특별히 메모리를 많이 요구하는 코드도 없었기 때문이다. 그래서 메모리 분석을 위해 jvm의 heap dump를 받아보기로 했다. <code class=\"language-text\">sudo -u user jmap -dump:format=b,file=dump.bin pid</code> 명령을 사용했다. </p>\n<p>dump는 시간이 꽤 걸렸는데 메모리 사용량에 따라 다르겠지만.. 기억하기로는 2G일 때 2시간 정도 걸렸던 듯하다. 시간이 걸리는 작업이기 때문에 작업을 걸어놓고 다른 것을 하다가 나중에 확인했을 때 터미널이 끊어져 있는 불상사를 맞이하고 nohup으로 백그라운드에서 수행한 기억이 있다. 그리고 AWS EC2에서는 package를 설치해야 jmap 실행이 가능했다<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>.</p>\n<p>덤프 파일 분석에는 eclipse의 <a href=\"https://www.eclipse.org/mat\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MAT(Memory Analyzer)</a>를 사용했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fef4ab90d53ea2e4701603bbb53608a1/a2b88/community-memory-dump.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.42857142857143%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACjElEQVQ4y4VTW08TYRDtT1SjDz4YiJrwjkpiongJKDGGiyUm+oAhNfhgiGKLUCiXKpRCaWi5lN5CsXULm17p7nZXdrvH+b5uS4ptnORkZvfbnjkz56tNkmSUSiWYpsnRLmrW+w7nupXtBJut+aNajefimYSPs8sY+vAZn+a9qMjKP6SXoFvZTrggZFFRqugbncC1+4O4+fAVrt4bwKO3Dqjan2bTNipbFWqahlNRRKVcwszqBq4/eIG7z8dw59kYegbGcaV3AEtb4RYGw6gTswaGYegUrLZTbbOxB0mW+YeTTg9u9A3h9tNR9AyO483UV8x4fiAciUKSJIjU+LcgIJI4QjR6CL/fj1AopKfTaXZuz+Vy9ZEbQwQO4kT4Et39w+h+MoIuyr2v3yMtnEBVq8jn8yiXy9BUldfZbBbFYrF15MZyG0t3kCG3Hg9zdPWPYGpuFf+JzqY0YjeWhHNlDXuxRPOdadbaOcxdttyvKzT0GhS5CkVRIVM+Pzegn+vQqipUcl3XGRFaYLVo1K0jVyu06EyMlp1AhnKpJJBjMnRDonPFQtWCQmcSOatYZBcKm4SZjJ8cW8bBgQe7u25sbzsRCHwj974jGHTR2RI12uA4Pl4nU8JEIhKx2Z4wGJyF0zmB6el3PLtcE3C7HfD5vmBubhKbmzPUxIV43ItUyodcLkhrETorDIfnwUhjsRVSs8IzU8pUJxJeCMIWkezQFQkgmfyJfGGH1J2i/k9tQ7i/v8C7K0qMEIWmJejOxcmgKO3qiL5Jc5jmL8Ix1SkiEzsTplLriEQWcXi4eGlfa3y8s7M9FEhVgStjDY6oUbYzYT4vkjKRatFa9inPDIZxQtcm2wR7ZmS6Xui4w7/k74uO6wdGdQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"community memory dump\"\n        title=\"community memory dump\"\n        src=\"/static/fef4ab90d53ea2e4701603bbb53608a1/b06ae/community-memory-dump.png\"\n        srcset=\"/static/fef4ab90d53ea2e4701603bbb53608a1/0d3e1/community-memory-dump.png 140w,\n/static/fef4ab90d53ea2e4701603bbb53608a1/908b1/community-memory-dump.png 280w,\n/static/fef4ab90d53ea2e4701603bbb53608a1/b06ae/community-memory-dump.png 560w,\n/static/fef4ab90d53ea2e4701603bbb53608a1/1e088/community-memory-dump.png 840w,\n/static/fef4ab90d53ea2e4701603bbb53608a1/a2b88/community-memory-dump.png 908w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/10c363e7619b181a3eb50ea30d587ad8/b12f7/community-memory-dump-detail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.14285714285715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3klEQVQ4y02TSavcRhSF6+fqJyQYQgLOwpCEZJ+NIYEQYzD2zhBIdsaO4Q3dryd1ay61pNI8dj89nRxVx89eHO5tuurUdweJ4/GI4zFElqVIUwWlYq22rfHwMOL+/v6zHh5wD2CkTqcT2qaZ+mEYu67DMAxG3/dCWJYP18kRRT2OYYsgaCHlHBvEcYO+H3i5x3A+oy9yDIt/MXz4B+XuDo7nTaGUo2maCMPQcF1XiCzLsFiscXcnGRVubmLGBMtlgv0+h2WXsPYZnOMZ1d9vMfz8FVpnPxOxinaKomg8HA4EigwppRBnvpwkRxoeaJLSUGnj9Tpl6TXyvNGqqhangaRzudNEwx51XU9s2aNhEARClGXFwx1JArhuQVXwvAqBX/FCR4pex7LsUBQtyoIPZA26bmA7+ilN05FG7H9qJEkiRJ7nmkCpCubehWlm2O1yKiNlRnKlS7dZuueWmnQmb5qeaiZSjrNHHMcGaYWYe3E6DTifT4iTGKvVlmYRNpsc2+3F1DoUHNKFPI7ry5B4by5ZKTX6vv+5h8TGJ82r4PsezSKaFjBnylVGuhwymE0L9rvG/2uiCWdDz/M0ISctBCelD7Rtx6jLoJlFshgbDma94pBulR7Ycqm4s/UjQFEUE8/rkkl3WRs682UiM0ZRTTWkVLCsmCWWcJxCD8v3Sx3rup3X5dGwLMuRZvzfN2zbFsJ1HDh2AtsqGHMt2+JQtpE2cOxClzwv/yclccUVGvSX0nXt2NT1/JUZSnHKcVogUo1W/EX0ZIabxRbXtyGurhNc3yS4omTIdWpaVE2HJM2nrKhGRviBNGyHJT97FeCH1xI/vrnopzchfwfMA/zy2sLTP318/VuAJ7/PkvjmD4lvX0g8fSnx3Qs5MY7fvwzw/C/P+PUtDa8Xd7hd7nC7cEhkM3dIZePd+zXefdjgivnHKwdr08Xe9rGzPOwOHkzmG9OZmI9r02FuG6vtQfwH/b/w2U0aLXUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"community memory dump detail\"\n        title=\"community memory dump detail\"\n        src=\"/static/10c363e7619b181a3eb50ea30d587ad8/b06ae/community-memory-dump-detail.png\"\n        srcset=\"/static/10c363e7619b181a3eb50ea30d587ad8/0d3e1/community-memory-dump-detail.png 140w,\n/static/10c363e7619b181a3eb50ea30d587ad8/908b1/community-memory-dump-detail.png 280w,\n/static/10c363e7619b181a3eb50ea30d587ad8/b06ae/community-memory-dump-detail.png 560w,\n/static/10c363e7619b181a3eb50ea30d587ad8/1e088/community-memory-dump-detail.png 840w,\n/static/10c363e7619b181a3eb50ea30d587ad8/b12f7/community-memory-dump-detail.png 1020w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>분석해보니 <code class=\"language-text\">PartTreeJpaQuery</code>라는 클래스에서 사용하는 <code class=\"language-text\">ConcurrentHashMap</code>이 메모리를 많이 차지하고 있었다.  관련된 내용이 있는지 검색해 보았고 나의 증상과 비슷해 보이는 Spring Data JPA <a href=\"https://jira.spring.io/browse/DATAJPA-1647\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">이슈</a>를 발견할 수 있었다.</p>\n<h3 id=\"datajpa-1647\" style=\"position:relative;\"><a href=\"#datajpa-1647\" aria-label=\"datajpa 1647 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DATAJPA-1647</h3>\n<p>이 이슈에서는 JPA repository의 <code class=\"language-text\">findBy...</code>의 파라미터로 <code class=\"language-text\">Pageable</code>을 사용할 때 메모리 누수가 있는 것 같다고 제보하고 있었다. 그리고 이 이슈는 장애가 발생한 날의 불과 4일 전에 버전 올림 되면서 수정되었다. <a href=\"https://github.com/spring-projects/spring-data-jpa/pull/402\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PR</a>을 보면 이전에 넣은 기능을 롤백하는 것인데 <a href=\"https://jira.spring.io/browse/DATAJPA-1575\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DATAJPA-1575</a>으로 2019년 8월 5일 2.2.0.RC2 버전에 포함되었다. </p>\n<p>정리하면 2019년 8월 5일에 Spring Data JPA의 2.2.0.RC2에 추가된 기능을 2020년 1월 15일에 2.2.4와 2.3.0 버전 이상에서는 이전 코드로 되돌려 해결하였다. 문제가 있었던 프로젝트는 Spring Boot 2.2.0을 사용하고 있었고 댓글을 조회하고 페이징하기 위해 <code class=\"language-text\">JpaRepository</code>를 상속한 인터페이스에서 <code class=\"language-text\">findBy...</code>에 <code class=\"language-text\">Pageable</code>을 파라미터로 사용하고 있었다.</p>\n<h3 id=\"검증\" style=\"position:relative;\"><a href=\"#%EA%B2%80%EC%A6%9D\" aria-label=\"검증 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>검증</h3>\n<p>같은 코드에서 Spring Data JPA 버전만을 변경하여 heap 메모리 사용을 비교해 보기로 했다.\n환경은 Java 1.8을 사용하였고, Heap의 최초, 최대 크기는 1G로 설정했다. 그리고 nGinrder로 100명의 가상 유저로 요청을 시뮬레이션하였으며 Scouter로 모니터링하였다. 각 요청은 아래의 코드를 수행하게 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/memoryLeakTest\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">memoryLeakTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByComment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">PageRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"spring-data-jpa-220\" style=\"position:relative;\"><a href=\"#spring-data-jpa-220\" aria-label=\"spring data jpa 220 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spring Data JPA 2.2.0</h4>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/86f37920260c2686345c32f9c0f578b0/b1945/memory-leak-jpa-2.2.0-heap.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA80lEQVQ4y82TW4/CIBCF+/9/n4luYozdbNdLdS23UqB4ZMBLE7F2sy/7cALDzHycQimklOj7PsjBuSRrXVzTnYWUBibErTYx7kjGwhh3VZrfegvGONrWxobNXmK+/MFnxbFcN6g2Ag3T0NrGRtqI4DajO7A+nFB+JcDs44hFAG5rCSa66Nr75D59xWNOzWke5AbAVVljHYCrssGuVtH+OUAI5AaFQ92AORXV9xGqNTFIbl4XTwIKwbNuxppGgZzzbMH/BT5usH9qnpILZygGv8TfFR2+u9XfqKCn571/2im3NiUXnh4DQZVS9/GVKD9WS8d3AZ2M+eF6BLLcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JPA 2.2.0 Heap\"\n        title=\"JPA 2.2.0 Heap\"\n        src=\"/static/86f37920260c2686345c32f9c0f578b0/b06ae/memory-leak-jpa-2.2.0-heap.png\"\n        srcset=\"/static/86f37920260c2686345c32f9c0f578b0/0d3e1/memory-leak-jpa-2.2.0-heap.png 140w,\n/static/86f37920260c2686345c32f9c0f578b0/908b1/memory-leak-jpa-2.2.0-heap.png 280w,\n/static/86f37920260c2686345c32f9c0f578b0/b06ae/memory-leak-jpa-2.2.0-heap.png 560w,\n/static/86f37920260c2686345c32f9c0f578b0/1e088/memory-leak-jpa-2.2.0-heap.png 840w,\n/static/86f37920260c2686345c32f9c0f578b0/f43e4/memory-leak-jpa-2.2.0-heap.png 1120w,\n/static/86f37920260c2686345c32f9c0f578b0/b1945/memory-leak-jpa-2.2.0-heap.png 2754w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JPA 2.2.0 Heap</figcaption>\n  </figure>\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5bf9b5be6db76e5595b06f5f01cea1b9/cd13d/memory-leak-jpa-2.2.0-tps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABP0lEQVQoz22QzU8CMRDF+ee9evBiYrzoxYsmGr2p8aokxg8QAVcEhFWWhYXdbtvtxz6nZY3BcPjldWaa186rJUmC0po1rKm0wp2N+cNuwPetRc0VTDIiBZcZcqI0OQrFoDWD0TlkwXwPhsNSvQb13Z00X0IriRpVaMcxzoI+TrofOCW9GY5w/j7AMdW3YYjL/ieCeYzhcg5AePNNGFOQIa1z1R9jq97EfvMNe89d7Dy0cdgKsPvUwcFLgO37V1zQA653PRgBpQAs97+z/w3d7o+TCJ3ZFBFbeHW/GadzhGmCXhKjHn55ozvSo3YPjSjykThTlNxr6c3JUGlNB+FX+R2uUa5WlGTgcPe+s4RimqIxjejBGTLKfZUlZaiUghAueAEpuaegs0NRyG7mVFZaVHMhOBLGMCMmiwUy7lbW+AHkZxUuJNihEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JPA 2.2.0 TPS\"\n        title=\"JPA 2.2.0 TPS\"\n        src=\"/static/5bf9b5be6db76e5595b06f5f01cea1b9/b06ae/memory-leak-jpa-2.2.0-tps.png\"\n        srcset=\"/static/5bf9b5be6db76e5595b06f5f01cea1b9/0d3e1/memory-leak-jpa-2.2.0-tps.png 140w,\n/static/5bf9b5be6db76e5595b06f5f01cea1b9/908b1/memory-leak-jpa-2.2.0-tps.png 280w,\n/static/5bf9b5be6db76e5595b06f5f01cea1b9/b06ae/memory-leak-jpa-2.2.0-tps.png 560w,\n/static/5bf9b5be6db76e5595b06f5f01cea1b9/1e088/memory-leak-jpa-2.2.0-tps.png 840w,\n/static/5bf9b5be6db76e5595b06f5f01cea1b9/f43e4/memory-leak-jpa-2.2.0-tps.png 1120w,\n/static/5bf9b5be6db76e5595b06f5f01cea1b9/cd13d/memory-leak-jpa-2.2.0-tps.png 1958w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JPA 2.2.0 TPS</figcaption>\n  </figure></p>\n<p>시작 후 30분가량 후에 힙 사이즈가 최대치인 1G에 도달하였고 GC로도 메모리가 회수되지 않아 점차 사용 가능한 메모리가 줄어드는 모습을 보여주었다. 사용 가능한 메모리가 줄어들면서 TPS도 급감하였다. (날짜가 변경되어서 그런지 Scouter에서 Heap 메모리 로그가 전부 보이지 않는데 100M부터 점차 사용량이 증가하였다.)</p>\n<h4 id=\"spring-data-jpa-224\" style=\"position:relative;\"><a href=\"#spring-data-jpa-224\" aria-label=\"spring data jpa 224 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spring Data JPA 2.2.4</h4>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a32e29dfa641c5222447b38b56c8a4b/ba168/memory-leak-jpa-2.2.4-heap.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnklEQVQ4y62SaS8DcRDG99N65QM4IiISQuoKkVJSSkhECS8QCd6oIxRptemh1JlqZY//7vbY67E7q5oK2ogXv2R2/jtPZp4ZTlVVGIbxb3CSJFGg63pTNPqXY4z9r6CiKE0LVsdqSrARuv7BXz3U6jrTYZkGTBvLMun7Vw9JQHMTtULjM65UNLwWVLzxRdw/MUisRO/fCsqyDMCyMSkhiCUwuUyFe6FnnFzkcHr5Ct9SAgvBNMb9MTw8M6pxm6jZQSMLooR4ikcyI+A4nINvOYHg1h38K0n0TVxh2BeFZzqC9oEzeKYi6B4K4/Zeog7LZY26Jz4m5CLxF3QOnmNkJooOu6it/4yEekYvMDEXw6A3gt6xS0wG4lhYS2NzNwterI3s+ElUR17fTqGlLYTWriN0ecI00ujsNQLBFPYOn7BhCzjd5/IKso8SiiWNfP1xKTsHGcyvpuBdjGPf9uwmK5IALxTJI8dPZzmOx+6GjbqbrD8tWzBfEKGoFRuNjHUXZFGxadZEqji53+BEUYCiyIQsOydhIzE458S+xM3wDtT5JSWce5ExAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JPA 2.2.4 Heap\"\n        title=\"JPA 2.2.4 Heap\"\n        src=\"/static/3a32e29dfa641c5222447b38b56c8a4b/b06ae/memory-leak-jpa-2.2.4-heap.png\"\n        srcset=\"/static/3a32e29dfa641c5222447b38b56c8a4b/0d3e1/memory-leak-jpa-2.2.4-heap.png 140w,\n/static/3a32e29dfa641c5222447b38b56c8a4b/908b1/memory-leak-jpa-2.2.4-heap.png 280w,\n/static/3a32e29dfa641c5222447b38b56c8a4b/b06ae/memory-leak-jpa-2.2.4-heap.png 560w,\n/static/3a32e29dfa641c5222447b38b56c8a4b/1e088/memory-leak-jpa-2.2.4-heap.png 840w,\n/static/3a32e29dfa641c5222447b38b56c8a4b/f43e4/memory-leak-jpa-2.2.4-heap.png 1120w,\n/static/3a32e29dfa641c5222447b38b56c8a4b/ba168/memory-leak-jpa-2.2.4-heap.png 2644w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JPA 2.2.4 Heap</figcaption>\n  </figure>\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0577cabfa5feffe5869a511b066653d2/4ca46/memory-leak-jpa-2.2.4-tps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABTUlEQVQoz2WRW0/CQBCF+/9/g89e0Bg1URJffJDE6JsxURFsAaEoCN1edrd763GmIpr4cHLOzNd2d6aREAJoAskDYSPKTXAU3dbDtt6w8JN927fOUs8j4qJQBcZihVIX+KwEFqWAtRW8q1pvvIQjD05Cm7LtOWKqLqE2dSFz1EYjauiDt+k7TocjdJMJDvoxOqT957jtdfoJjl4S7D694ngwwiFl7u0R57xLzvxqMkUsckRSa9x/LJAWGW5mKXYeBrieztCNJ3hcLtCbpjgbjlvxYXfzOS5Hb7gg3qPnmJ/HY5zQ4YO1QGSsxVoWkHT9TOVIshVyGp3HNzRKTSMxq+oCS1oH59qW22e45jwvMxRaIXKOFuwULVbSD2Gp1nlvLPxV+O3948SCN3RDY2BqDWvqVjVn++3OGmg6lWulJAxxrdl1y5mxM+N3vff4AuX6EkjNJT1dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JPA 2.2.4 TPS\"\n        title=\"JPA 2.2.4 TPS\"\n        src=\"/static/0577cabfa5feffe5869a511b066653d2/b06ae/memory-leak-jpa-2.2.4-tps.png\"\n        srcset=\"/static/0577cabfa5feffe5869a511b066653d2/0d3e1/memory-leak-jpa-2.2.4-tps.png 140w,\n/static/0577cabfa5feffe5869a511b066653d2/908b1/memory-leak-jpa-2.2.4-tps.png 280w,\n/static/0577cabfa5feffe5869a511b066653d2/b06ae/memory-leak-jpa-2.2.4-tps.png 560w,\n/static/0577cabfa5feffe5869a511b066653d2/1e088/memory-leak-jpa-2.2.4-tps.png 840w,\n/static/0577cabfa5feffe5869a511b066653d2/f43e4/memory-leak-jpa-2.2.4-tps.png 1120w,\n/static/0577cabfa5feffe5869a511b066653d2/4ca46/memory-leak-jpa-2.2.4-tps.png 1944w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JPA 2.2.4 TPS</figcaption>\n  </figure></p>\n<p>2시간 정도 수행하였는데도 600M 아래로 사용하고 있고 TPS 저하 현상도 보이지 않았다. </p>\n<h3 id=\"무엇을-하려고-했던-걸까\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%97%87%EC%9D%84-%ED%95%98%EB%A0%A4%EA%B3%A0-%ED%96%88%EB%8D%98-%EA%B1%B8%EA%B9%8C\" aria-label=\"무엇을 하려고 했던 걸까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>무엇을 하려고 했던 걸까?</h3>\n<p>위의 PR에서 보다 시피 이전 코드는 <code class=\"language-text\">ParameterBinder</code>를 생성하고 Map에 저장하여 재사용하려고 했고 변경된 코드는 <code class=\"language-text\">ParameterBinder</code>를 생성한 뒤에 별다른 작업 없이 바로 반환해주고 있다. 이전 코드에서는 생성 비용을 줄이려고 Map에 저장한 뒤에 재사용하는 것을 의도했지만 키로 사용한 <code class=\"language-text\">ParameterMetadata</code>객체의 동일성을 보장해주지 못해 메모리 누수가 발생한 것으로 보인다. 실제로 debugger로 확인했을 때 동일한 인수임에도 Map의 크기가 호출할 때마다 늘어나는 것을 볼 수 있었다.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><a href=\"https://stackoverflow.com/questions/43753568/aws-ec2-jmap-heap-dump\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://stackoverflow.com/questions/43753568/aws-ec2-jmap-heap-dump</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","excerpt":"…","tableOfContents":"<ul>\n<li><a href=\"/memory-leak-the-first/#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\">문제 발생</a></li>\n<li><a href=\"/memory-leak-the-first/#%EC%9B%90%EC%9D%B8-%ED%8C%8C%EC%95%85\">원인 파악</a></li>\n<li><a href=\"/memory-leak-the-first/#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EB%B6%84%EC%84%9D\">메모리 분석</a></li>\n<li><a href=\"/memory-leak-the-first/#datajpa-1647\">DATAJPA-1647</a></li>\n<li><a href=\"/memory-leak-the-first/#%EA%B2%80%EC%A6%9D\">검증</a></li>\n<li><a href=\"/memory-leak-the-first/#%EB%AC%B4%EC%97%87%EC%9D%84-%ED%95%98%EB%A0%A4%EA%B3%A0-%ED%96%88%EB%8D%98-%EA%B1%B8%EA%B9%8C\">무엇을 하려고 했던 걸까?</a></li>\n</ul>","fields":{"slug":"/memory-leak-the-first/"},"frontmatter":{"title":"내가 겪은 메모리 누수 이야기 - 첫 번째","date":"2020년 6월 29일 월요일","tags":["memoryLeak","springDataJpa"],"keywords":["Running Out Of Coins.","bgroot"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/memory-leak-the-first/","series":[],"lastmod":"0001-01-01"}},"staticQueryHashes":["3649515864","63159454"]}